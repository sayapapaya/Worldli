{% extends "app/base.html" %}

{% block script %}
<script>
  window.fbAsyncInit = function() {
    FB.init({
      appId      : '926754177344550',
      xfbml      : true,
      version    : 'v2.2'
    });
  };

  (function(d, s, id){
     var js, fjs = d.getElementsByTagName(s)[0];
     if (d.getElementById(id)) {return;}
     js = d.createElement(s); js.id = id;
     js.src = "//connect.facebook.net/en_US/sdk.js";
     fjs.parentNode.insertBefore(js, fjs);
   }(document, 'script', 'facebook-jssdk'));

$(document).ready(function(){

var options = {
  sky: true,
  atmosphere: true,
  dragging: true,
  tilting: true,
  zooming: true,
  center: [46.8011, 8.2266],
  zoom: 2
};
earth = new WE.map('earth_div', options);
var natural = WE.tileLayer('http://data.webglearth.com/natural-earth-color/{z}/{x}/{y}.jpg', {
  tileSize: 256,
  tms: true
});
natural.addTo(earth);

var toner = WE.tileLayer('http://tile.stamen.com/toner/{z}/{x}/{y}.png', {
  attribution: 'Map tiles by Stamen Design, under CC BY 3.0. Data by OpenStreetMap, under CC BY SA.',
  opacity: 0.6
});
toner.addTo(earth);

var marker_dict = {};

{% for problem, images in image_dict.items %}
  var marker = WE.marker([{{problem.latitude}},{{problem.longitude}}]).addTo(earth);
  marker_dict[{{ problem.id }}] = marker;
  marker.bindPopup("<center><h3>{{problem.title}}</h3></center><span 'style='font-size:8px;color:#999'><img src='{{ images.0.image.url }}' width='100%' height='auto'><a href='{% url 'view_post' problem.id %}'>Read more</a></span>",{maxWidth:150,closeButton:true})
{% endfor %}

/*
  var marker2 = WE.marker([40, -70]).addTo(earth);
  marker2.bindPopup("<h3>Lack of Clean Water</h3><span 'style='font-size:8px;color:#999'><img src='http://www.nofrackingway.us/wp-content/uploads/2012/09/dirty-water.jpeg' width='100px' height='100px'><br>there is rarely an clean water in India. It kinda sucks. People drink their own urine half the time.<br /><h6> by Saya Date </h6></span>", {maxWidth: 150, closeButton: true})//.openPopup();*/



// Search bar
function hitEnter(e){
  var key = e.which || e.keyCode;
  if (key == 13) { // 13 is enter
    var search_text = $('#search')[0].value;
    $.ajax({
      url: "{% url 'search' %}",
      type: "POST",
      data: {"search_text": search_text},
      success: function(result) {
        // sets the earth view at a certain latitude and longitude
        earth.setView([result.latitude,result.longitude],earth.getZoom());
        marker_dict[result.id].openPopup();
      },
      error: function(xhr, errmsg, err) {
        console.log(errmsg);
      }
    });
  }
}

function searchFunction(){
  var search_text = $('#search')[0].value;
  var one = $('#search-button-1')[0].innerHTML;
  var two  = $('#search-button-2')[0].innerHTML;
  var url;
  if ( one.indexOf("Problems") > -1){ // the string contains "Problems"
    if (two.indexOf("Name") > -1){
      url = "{% url 'search'%}";
    } else {
    }
  } else {
    if (two.indexOf("Name") > -1){
      url = "{% url 'search_people_name' %}";
    } else {
      url = "{% url 'search_skills' %}";
    }
  }
  $.ajax({
    url: url,
    type: "POST",
    data: {"search_text": search_text},
    success: function(result) {
      // sets the earth view at a certain latitude and longitude
      //earth.setView([result.latitude,result.longitude],earth.getZoom());
      //marker_dict[result.id].openPopup();
      console.log(result);
    },
    error: function(xhr, errmsg, err) {
      console.log(errmsg);
    }
  });
}

$('#search')[0].addEventListener("keyup", function(){
  var csrftoken = getCookie('csrftoken');
  $.ajaxSetup({
    beforeSend: function(xhr, settings) {
        if (!csrfSafeMethod(settings.type) && !this.crossDomain) {
            xhr.setRequestHeader("X-CSRFToken", csrftoken);
        }
    }
  });
  var search_text = $('#search')[0].value;
  $.ajax({
    url: "{% url 'search_autocomplete' %}",
    type: "POST",
    data: {"search_text": search_text},
    success: function(result) {
      console.log(result);
      var tags = [];
      for (var i=1; i <= Object.keys(result[0]).length && i<= 3; i++){
        tags.push(result[0][i].title);
      };
      for (var i=1; i <= Object.keys(result[1]).length && i<=3; i++){
        tags.push(result[1][i].name);
      };
      console.log(tags);
      if (tags.length == 0){
        tags.push("No search results");
      };
      $( "#search" ).autocomplete({
        source: tags,
        select: searchFunction
      });
    },
    error: function(xhr, errmsg, err) {
      console.log(errmsg);
    }
  });
});

$('#search-button-submit')[0].addEventListener('click', searchFunction);

$('#problems-choice')[0].addEventListener('click', function(){
  $('#search-button-1')[0].innerHTML = this.children[0].innerHTML + "&nbsp<span class='caret'></span>";
  $('#category-chioce')[0].style.display = "block";
  $('#skills-chioce')[0].style.display = "none";
});

$('#people-chioce')[0].addEventListener('click', function(){
  $('#search-button-1')[0].innerHTML = this.children[0].innerHTML + "&nbsp<span class='caret'></span>";
  $('#category-chioce')[0].style.display = "none";
  $('#skills-chioce')[0].style.display = "block";
})

function changeButtonName(){
  $('#search-button-2')[0].innerHTML = this.children[0].innerHTML + "&nbsp<span class='caret'></span>";
}

$('#name-chioce')[0].addEventListener('click', changeButtonName);
$('#skills-chioce')[0].addEventListener('click', changeButtonName);
$('#category-chioce')[0].addEventListener('click', changeButtonName);


});

</script>
{% endblock %}


{% block nav %}

{% if user and not user.is_anonymous %}
<ul class="nav navbar-nav navbar-left">
	<li><a href="{% url 'create_post' %}">Post a Problem</a></li>
</ul>
{% endif %}

{% endblock %}


{% block content %}

{% if not user or user.is_anonymous %}
	<div id="social-container">
		<div class="fb-icon-bg"></div>
		<div class="fb-bg" onclick="location.href='{% url 'social:begin' 'facebook' %}?next={{ request.path }}'"></div>
	</div>
{% endif %}


<!--<div class="search">
  <input id="search" type="search" placeholder="Search">
</div>-->
<center>
<div id="search-container">
<div class="form-inline">
  <div class="form-group">
    <input type="text" class="form-control" id="search" placeholder="Search">
  </div>
  <div class="btn-group">
    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false" id="search-button-1">Problems&nbsp<span class="caret"></span>
    </button>
    <ul class="dropdown-menu" role="menu">
      <li id="problems-choice"><a href="#">Problems</a></li>
      <li id="people-chioce"><a href="#">People</a></li>
    </ul>
  </div>
  <div class="btn-group">
    <button type="button" class="btn btn-default dropdown-toggle" data-toggle="dropdown" aria-expanded="false" id="search-button-2">Name&nbsp<span class="caret"></span>
    </button>
    <ul class="dropdown-menu" role="menu">
      <li id="name-chioce"><a href="#">Name</a></li>
      <li id="skills-chioce" style="display:none;"><a href="#">Skills</a></li>
      <li id="category-chioce"><a href="#">Category</a></li>
    </ul>
  </div>
  <button type="submit" id="search-button-submit" class="btn btn-default">Search</button>
</div>
</div>
</center>

<div id="earth_div"></div>

{% endblock%}
